<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-body">
            <h1 class="text-center mb-4 text-primary">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</h1>
            <form method="POST" enctype="multipart/form-data" id="certificateForm">
                <!-- –†–∞–∑–¥–µ–ª: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ -->
                <div class="mb-4">
                    <h4 class="text-secondary">üìò –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ</h4>
                    <div class="mb-3">
                        <label for="course_title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                        <input type="text" class="form-control" id="course_title" name="course_title" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è">
                    </div>
                    <div class="mb-3">
                        <label for="issue_date" class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</label>
                        <input type="date" class="form-control" id="issue_date" name="issue_date" required>
                    </div>
                </div>
                
                <!-- –†–∞–∑–¥–µ–ª: –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
                <div class="mb-4">
                    <h4 class="text-secondary">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
                    <div class="mb-3">
                        <label for="user_names" class="form-label">–ò–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                        <textarea class="form-control" id="user_names" name="user_names" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤, –ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="file_upload" class="form-label">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                        <input type="file" class="form-control" id="file_upload" name="file_upload" accept=".txt,.csv">
                        <div class="form-text">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã —Ñ–æ—Ä–º–∞—Ç–∞ <code>.txt</code> –∏–ª–∏ <code>.csv</code>
                        </div>
                    </div>
                </div>

                <!-- –†–∞–∑–¥–µ–ª: –®–∞–±–ª–æ–Ω -->
                <div class="mb-4">
                    <h4 class="text-secondary">üñºÔ∏è –®–∞–±–ª–æ–Ω</h4>
                    <div class="mb-3">
                        <label for="orientation" class="form-label">–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –º–∞–∫–µ—Ç–∞</label>
                        <select class="form-select" id="orientation" name="orientation">
                            <option value="horizontal">–ê–ª—å–±–æ–º–Ω–∞—è</option>
                            <option value="vertical">–ö–Ω–∏–∂–Ω–∞—è</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="template" class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω –º–∞–∫–µ—Ç–∞</label>
                        <input type="file" class="form-control" id="template" name="template" accept=".jpg,.png">
                        <div class="form-text">
                            –î–ª—è –∞–ª—å–±–æ–º–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏: <code>3508x2480 –ø–∏–∫—Å–µ–ª–µ–π</code>, –¥–ª—è –∫–Ω–∏–∂–Ω–æ–π: <code>2480x3508 –ø–∏–∫—Å–µ–ª–µ–π</code>.
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</button>
                    <button type="button" class="btn btn-secondary btn-lg" id="previewButton">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="card mt-5 shadow-sm">
        <div class="card-body text-center">
            <h4 class="text-secondary">üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h4>
            <div id="loadingSpinner" class="spinner-border text-primary" style="display: none;" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <img id="previewImage" src="#" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞" class="img-fluid mt-3" style="display: none; max-height: 500px;">
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–∫–∏ -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">–û—à–∏–±–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="error-message"></p> <!-- –ú–µ—Å—Ç–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ -->
            </div>
        </div>
    </div>
</div>

<script>
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    document.getElementById('previewButton').addEventListener('click', function () {
        var userNames = document.getElementById('user_names').value.trim();
        var courseTitle = document.getElementById('course_title').value.trim();
        var issueDate = document.getElementById('issue_date').value.trim();
        var orientation = document.getElementById('orientation').value;
        var template = document.getElementById('template').files[0];

        if (!userNames || !courseTitle || !issueDate) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
            return;
        }

        var formData = new FormData();
        formData.append("user_names", userNames);
        formData.append("course_title", courseTitle);
        formData.append("issue_date", issueDate);
        formData.append("orientation", orientation);
        if (template) {
            formData.append("template", template);
        }

        var spinner = document.getElementById('loadingSpinner');
        var previewImage = document.getElementById('previewImage');
        spinner.style.display = "block";
        previewImage.style.display = "none";

        fetch("/preview", {
            method: "POST",
            body: formData
        }).then(function (response) {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞.');
            }
        }).then(function (blob) {
            var url = URL.createObjectURL(blob);
            previewImage.src = url;
            previewImage.style.display = "block";
        }).catch(function (error) {
            alert(error.message);
        }).finally(function () {
            spinner.style.display = "none";
        });
    });

    // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ—à–∏–±–∫–æ–π
    window.addEventListener("load", function () {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞
        var errorMessage = "{{ error_message or '' }}";  // –µ—Å–ª–∏ error_message None, —Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        if (errorMessage) {
            var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            document.getElementById('error-message').innerText = errorMessage; // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
            errorModal.show();
        }
    });
</script>
</body>
</html>
